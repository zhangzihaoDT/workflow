# W35 异常检测工作流

## 工作流架构

```mermaid
flowchart TD
    A[开始] --> B[异常检测节点]
    B --> C[结构检查节点]
    C --> G[销售代理分析节点]
    G --> H[时间间隔分析节点]
    H --> D[生成综合报告]
    D --> E[更新README图示]
    E --> F[结束]
    
    B --> B1[数据质量检查]
    B --> B2[缺失值检测]
    B --> B3[重复数据检测]
    B --> B4[生成异常检测报告]
    
    C --> C1[地区分布异常检查]
    C --> C2[渠道结构异常检查]
    C --> C3[人群结构异常检查]
    C --> C4[生成结构检查报告]
    
    G --> G1[读取销售代理数据]
    G --> G2[分析各车型订单比例]
    G --> G3[生成销售代理分析报告]
    
    H --> H1[支付到退款时间间隔分析]
    H --> H2[支付到分配时间间隔分析]
    H --> H3[车型对比分析]
    H --> H4[生成时间间隔分析报告]
    
    D --> D1[整合异常检测报告]
    D --> D2[整合结构检查报告]
    D --> D3[整合销售代理分析报告]
    D --> D4[整合时间间隔分析报告]
    D --> D5[生成综合分析报告]
    
    style A fill:#e1f5fe
    style B fill:#f3e5f5
    style C fill:#e8f5e8
    style G fill:#e3f2fd
    style H fill:#fce4ec
    style D fill:#fff3e0
    style E fill:#ffebee
    style F fill:#f1f8e9
```

## 功能说明

### 异常检测节点
- 文件存在性检查
- 数据读取验证
- 基本统计信息收集
- 缺失值检测与分析
- 重复数据检测
- 数据类型分布分析
- 异常值识别

### 结构检查节点
- 地区分布异常检测：对比CM2车型与历史车型的地区订单分布变化
- 渠道结构异常检测：分析各渠道销量占比的突变情况
- 人群结构异常检测：检测性别比例和年龄段结构的大幅变化
- 基于业务定义的时间范围进行数据筛选

### 销售代理分析节点
- 读取销售代理数据：从sales_info_data.json获取Store Agent信息
- 订单比例分析：计算各车型预售周期中来自Store Agent的订单比例
- 异常检测：识别销售代理订单比例的异常情况
- 基于业务定义的预售周期进行数据筛选

### 时间间隔分析节点
- 支付到退款时间间隔分析：计算各车型从支付到退款的时间间隔统计
- 支付到分配时间间隔分析：计算各车型从支付到分配的时间间隔统计
- 车型对比分析：对比不同车型的时间效率表现
- 异常检测：识别时间间隔的异常模式和趋势
- 基于业务定义的预售周期进行数据筛选

### 综合报告生成
- 整合异常检测、结构检查、销售代理分析和时间间隔分析结果
- 提供数据质量、结构异常、销售渠道和时间效率的综合评估
- 基于检测结果提供相应的处理建议

### 报告生成
- 自动生成详细的MD格式异常检测报告
- 生成结构检查报告
- 生成销售代理分析报告
- 生成时间间隔分析报告
- 生成综合分析报告
- 包含数据质量评级
- 提供可视化的异常统计信息

### 工作流特性
- 基于LangGraph框架构建
- 模块化节点设计
- 多维度异常检测（数据质量+业务结构）
- 完整的错误处理机制
- 详细的日志记录

## 使用方法

```bash
# 激活虚拟环境
source .venv/bin/activate

# 运行异常检测工作流
python main.py
```

## 输出文件
- `anomaly_detection_report.md`: 详细的异常检测报告
- `structure_check_report.md`: 结构检查详细报告
- `sales_agent_analysis_report.md`: 销售代理订单比例分析报告
- `time_interval_analysis_report.md`: 时间间隔分析详细报告
- `complete_analysis_report.md`: 综合分析报告
- 控制台日志: 实时处理状态信息

## 配置文件
- `business_definition.json`: 业务时间范围定义，用于结构检查的数据筛选
